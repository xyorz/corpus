{% extends 'base.html' %}
{% load staticfiles %}
{% block title %}浙大汉语史研究中心中古汉语语料库{% endblock %}
{% block css %}
    <link href="{% static 'css/corpus_search.css' %}" rel="stylesheet">
{% endblock %}


{% block content %}
<script>
function fixTagName(name){
    var res = '';
    switch (name) {
        case 'author': {
            res = '作者';
            break
        }
        case 'dynasty': {
            res = '朝代';
            break
        }
        case 'area': {
            res = '地域';
            break
        }
        default: {
            res = name
        }
    }
    return res;
}
function showBack(beg, end, id ,search_field) {
    $("#show_content").css("visibility","visible");
    $.get("{% url 'corpus:content' %}", {'beg':beg, 'end': end, 'id': id, 'field': 1}, function (res) {

        if(res.hasOwnProperty('document')){
            $("#content_document").html(res['document'])
        }
        if(res.hasOwnProperty('section') && res['section']){
            $("#content_section").html(res['section']);
            $("#content_section").parent("tr").removeClass("hidden")
        } else {
            $("#content_section").parent("tr").addClass("hidden")
        }
        var last = "<p>" + res['last'].replace("\n", "</p><p>") + "</p>";
        var next = "<p>" + res['next'].replace("\n", "</p><p>") + "</p>";
        $("#content_last").html(last);
        $("#content_this").html(res['this']);
        $("#content_next").html(next);

        $("#show_content").css({
            "visibility": "visible",
            "position": "absolute",
            "top": (document.documentElement.scrollTop + 325) + "px"
        });

        bindShowDetail();
        bindShowZhujie();
    });
}
function bindShowDetail() {
    $(".detail").each(function (index, element) {
        $(element).mouseenter(function (e) {
            var detailInfo = JSON.parse($(element).attr('data-detail'));
            var detailHTML = "";
            $("#detail_div").css({visibility: 'visible', top: e.pageY + 'px', left: e.pageX + 'px'});
            for(var key in detailInfo){
                if(detailInfo.hasOwnProperty(key)){
                    if (key === 'null') {
                        continue
                    }
                    if (key === "detail"){
                        if (detailInfo[key] && Array.isArray(detailInfo[key])) {
                            detailInfo[key].forEach(function (item) {
                                if (item.name === null) return;
                                detailHTML += "" +
                                    "<p>" +
                                    "<span class='detail-name'>" + item.name + "：</span>" +
                                    "<span class='detail-value'>" + item.value + "</span>" +
                                    "</p>"
                            })
                        }

                    }
                    else{
                        if(detailInfo[key]){
                            detailHTML += "" +
                                "<p>" +
                                "<span class='detail-name'>" + fixTagName(key) + "：</span>" +
                                "<span class='detail-value'>" + detailInfo[key] + "</span>" +
                                "</p>"
                        }
                    }
                }
            }
            document.getElementById("detail_div").innerHTML = detailHTML
        });
        $(element).mouseout(function () {
            $("#detail_div").css({visibility: 'hidden'})
        })
    });
}
function bindShowZhujie(){
    $(".zhujie").each(function (index, element) {
        var zhujieInfo = element.getAttribute('data-zhujie');
        zhujieInfo = JSON.parse(zhujieInfo).zhujie;
        var charCount = 0;
        var skipFlag = false;
        var innerHTML = element.innerHTML;
        for(var infoIndex in zhujieInfo){
            charCount = 0;
            var zhujieIcon = '<span class="zj" style="font-size: 1.5em; color: black; margin: 0 5px" data-value="' + zhujieInfo[infoIndex].value + '">*</span>';
            for(var i=0; charCount<zhujieInfo[infoIndex].offset; i++){
                if(innerHTML[i] === '<'){
                    skipFlag = true;
                }else if(innerHTML[i] === '>'){
                    skipFlag = false;
                    continue
                }
                if(!skipFlag && innerHTML[i] !== '*'){
                    charCount += 1;
                }
            }
            if (i > innerHTML.length) {
                break
            }
            innerHTML = innerHTML.slice(0, i) + zhujieIcon + innerHTML.slice(i);
        }
        element.innerHTML = innerHTML;
    });
    $(".zj").each(function (index, element) {
        $(element).mouseenter(function (e) {
            e.stopPropagation();
            var zhujie = element.getAttribute('data-value');
            $("#zhujie_div").css({visibility: 'visible', top: e.pageY + 'px', left: e.pageX + 'px'});
            document.getElementById('zhujie_div').innerText = zhujie;
            $(element).mouseout(function () {
                $("#zhujie_div").css({visibility: 'hidden'})
            })
        })
    })
}
</script>
<form action="{% url 'corpus:search' %}" method="get" class="container-fluid col-md-offset-3 col-md-6" style="margin-top: 5%">
    <h2 style="text-align: center; color: #555555;">浙大汉语史研究中心中古汉语语料库</h2><br><br>
    <div class="form-group col-md-offset-1 col-md-8">
        <input class="form-control" type="text" name="search" id="search" value="{{ keyword }}" required="required" placeholder="请输入搜索内容">
    </div>
    <input type="submit" class="btn btn-primary col-md-2" value="提交"><br>
    <div class="form-group col-md-12">
        <div class="btn-group col-md-4" role="group">
            <div class="hidden">
                <input type="radio" class="hidden" name="search-type" id="normal" value="0" checked="checked">
                <label for="normal"></label>
                <input type="radio" class="hidden" name="search-type" id="pattern" value="1">
                <label for="pattern"></label>
            </div>
            <button type="button" class="btn btn-default active col-md-6" id="normal-button">普通查询</button>
            <button type="button" class="btn btn-default col-md-6" id="pattern-button">模式查询</button>
        </div>
        <div class="btn-group col-md-2" role="group">
           <div class="hidden">
                <input type="radio" class="hidden" name="search-field" id="modern" value="0" checked="checked">
                <label for="modern"></label>
                <input type="radio" class="hidden" name="search-field" id="ancient" value="1">
                <label for="ancient"></label>
            </div>
{#            <button type="button" class="btn btn-default col-md-6 active" id="ancient-button">古代汉语</button>#}
{#            <button type="button" class="btn btn-default col-md-6" id="modern-button">现代汉语</button>#}
        </div>
        <div class="col-md-2" style="line-height: 32px; font-size: 1.1em">显示长度：</div>
        <div class="form-group col-md-2">
            <input class="form-control" type="text" name="left-length" id="left-length" placeholder="左：{{ left_length }}">
        </div>
         <div class="form-group col-md-2">
            <input class="form-control" type="text" name="right-length" id="right-length" placeholder="右：{{ right_length }}">
        </div>
    </div>
    <div class="form-group col-md-12">
        <span style="font-size: 1.3em; line-height: 32px" class="pull-left">筛选条件：</span>
        <div class="form-group col-md-2">
            <input class="form-control" type="text" name="filter-author" id="filter-author" placeholder="作者">
        </div>
        <div class="form-group col-md-2">
{#            <input class="form-control" type="text" name="filter-dynasty" id="filter-dynasty" placeholder="朝代">#}
            <select class="form-control" id="filter-dynasty" name="filter-dynasty">
            </select>
        </div>
        <div class="form-group col-md-2">
{#            <input class="form-control" type="text" name="filter-area" id="filter-area" placeholder="地域">#}
            <select class="form-control" id="filter-area" name="filter-area">
            </select>
        </div>
        <div class="form-group col-md-2">
{#            <input class="form-control" type="text" name="filter-type" id="filter-type" placeholder="文体">#}
            <select class="form-control" id="filter-type" name="filter-type">
            </select>
        </div>
    </div>
</form>

<div class="container-fluid col-md-10" id="show_content">
    <button class="btn btn-default btn-sm pull-right close_content">关闭</button>
    <table class="table table-hover col-md-12" id="content_table">
        <tr>
            <td>文档名</td>
            <td id="content_document"></td>
        </tr>
        <tr>
            <td>章节名</td>
            <td id="content_section"></td>
        </tr>
        <tr>
            <td>上文</td>
            <td id="content_last"></td>
        </tr>
        <tr>
            <td>当前</td>
            <td id="content_this"></td>
        </tr>
        <tr>
            <td>下文</td>
            <td id="content_next"></td>
        </tr>
    </table>
    <button class="btn btn-default btn-sm pull-right close_content" style="margin-top: -2.5%;">关闭</button>
</div>

<div id="detail_div">
</div>

<div id="zhujie_div">
</div>

<div class="container-fluid col-md-offset-1 col-md-9">
{% if no_match %}
    <div class="alert alert-warning col-md-offset-2 col-md-10" style="cursor: default">
        <span class="text-center col-md-12">无匹配！</span>
    </div>
{% endif %}
{% if error_message %}
    <div class="alert alert-danger col-md-offset-2 col-md-10" style="cursor: default">
        <span class="text-center col-md-12">语法错误：{{ error_message }}</span>
    </div>
{% endif %}
{% if page_list %}
    {% if list %}
        <div class="alert alert-info col-md-offset-2 col-md-10" style="cursor: default">
            <span class="col-md-2 text-center">当前页 : {{ list.number }}</span>
            <span class="col-md-2 text-center">关键词: {{ keyword }}</span>
            <span class="col-md-2 text-center">耗时: {{ cost_time }}</span>
            <span class="col-md-offset col-md-6 text-center">
                {% if not list.has_next%}
                     共 {{ data }} 条结果， 当前显示 {% widthratio list.number|add:-1 1 30 %} - {{ data }}条
                {% else %}
                     共 {{ data }} 条结果， 当前显示 {% widthratio list.number|add:-1 1 30 %} - {% widthratio list.number 1 30 %}条
                {% endif %}
            </span>
        </div>
    {% endif %}
    <table class="table table-hover col-md-offset-1 col-md-12">
        {% for line in list %}
        <tr class="res_list">
            <td class="tab-left detail" data-detail="{{ line.detail }}" data-zhujie="{{ line.zhujie }}">{{ line.left|safe }}</td>
            <td class="tab-mid detail" data-detail="{{ line.detail }}" data-zhujie="{{ line.zhujie }}">{{ line.mid }}</td>
            <td class="tab-right detail" data-detail="{{ line.detail }}" data-zhujie="{{ line.zhujie }}">{{ line.right|safe }}
                <div class="text-button">
                    <button class="btn btn-default btn-xs content" onclick="showBack({{ line.beg }}, {{ line.end }}, '{{ line.id }}', '{{ search_field }}')">上下文</button>
                    <button class="btn btn-default btn-xs" onclick="window.location.href=window.location.origin + '/corpus/all_text/?id={{ line.id }}'">原文</button>
                </div>

            </td>
        </tr>
        {% endfor %}
    </table>
    {% if list.paginator.num_pages > 1 %}
        <ul class="pagination col-md-offset-4 col-md-8">
            {% if list.number|add:-5 > 0 %}
                <li><a href="?page=1&search={{ keyword|urlencode }}&left-length={{ left_length|urlencode }}&right-length={{ right_length|urlencode }}&search-type={{ type|urlencode }}&search-field={{ search_field|urlencode }}">1</a></li>
                {% if list.number|add:-5 != 1 %}
                    <li><a style="cursor: default">…</a></li>
                {% endif %}
            {% endif %}
            {% for num in page_list %}
                {% if forloop.counter < list.number|add:5 and  forloop.counter > list.number|add:-5 %}
                <li id="p_{{ forloop.counter }}">
                    <a href="?page={{ forloop.counter|urlencode }}&search={{ keyword|urlencode }}&left-length={{ left_length|urlencode }}&right-length={{ right_length|urlencode }}&search-type={{ type|urlencode }}&search-field={{ search_field|urlencode }}&filter-author={{ filter.author|urlencode }}&filter-area={{ filter.area|urlencode }}&filter-dynasty={{ filter.dynasty|urlencode }}&filter-type={{ filter.type|urlencode }}">
                        {{ forloop.counter }}
                    </a>
                </li>
                {% endif %}
            {% endfor %}
            {% if list.number|add:5 < list.paginator.num_pages|add:1 %}
                {% if list.number|add:5 < list.paginator.num_pages %}
                    <li><a style="cursor: default">…</a></li>
                {% endif %}
                <li>
                    <a href="?page={{ list.paginator.num_pages|urlencode }}&search={{ keyword|urlencode }}&left-length={{ left_length|urlencode }}&right-length={{ right_length|urlencode }}&search-type={{ type|urlencode }}&search-field={{ search_field|urlencode }}&filter-author={{ filter.author|urlencode }}&filter-area={{ filter.area|urlencode }}&filter-dynasty={{ filter.dynasty|urlencode }}&filter-type={{ filter.type|urlencode }}">
                        {{ list.paginator.num_pages }}
                    </a>
                </li>
            {% endif %}
        </ul>
    {% endif %}
{% endif %}
</div>
<script>
window.onload = function (ev) {
    var baseUrl = window.location.origin;

    var filterDefault = {{ filter|safe }};
    if (!filterDefault) {
        filterDefault = {};
    }
    // 请求下拉菜单值
    $.ajax({
        url: baseUrl + "/corpus/get_preset/",
        method: "POST",
        success: function (res) {
            if (res.list) {
                function getDataInList(list, key) {
                    return list.filter(function (item) {
                        return item.type === key;
                    })[0].value.split("|")
                }
                function renderOption(selector, list) {
                    var resHTML = "<option value=\"不限\">不限</option>";
                    list.forEach(function (item) {
                        resHTML += "<option value=\"" + item + "\">" + item + "</option>"
                    });
                    $(selector).html(resHTML)
                }
                var areaList = getDataInList(res.list, "area");
                var dynastyList = getDataInList(res.list, "dynasty");
                var typeList = getDataInList(res.list, "type");

                renderOption("#filter-area", areaList);
                renderOption("#filter-dynasty", dynastyList);
                renderOption("#filter-type", typeList);

                function setFilterDefault() {
                    var filterAuthor = filterDefault["author"];
                    var filterArea = filterDefault["area"];
                    var filterDynasty = filterDefault["dynasty"];
                    var filterType = filterDefault["type"];
                    if (filterAuthor) {
                        $("#filter-author").attr("value", filterAuthor);
                    }
                    if (filterArea) {
                        $("#filter-area").find("option").each(function () {
                            if ($(this).attr("value") === filterArea) {
                                $(this).attr("selected", true)
                            }
                        })
                    }
                    if (filterDynasty) {
                        $("#filter-dynasty").find("option").each(function () {
                            if ($(this).attr("value") === filterDynasty) {
                                $(this).attr("selected", true)
                            }
                        })
                    }
                    if (filterType) {
                        $("#filter-type").find("option").each(function () {
                            if ($(this).attr("value") === filterType) {
                                $(this).attr("selected", true)
                            }
                        })
                    }
                }

                setFilterDefault();
            }
        }
    });

    bindShowDetail();
    bindShowZhujie();
    $(".close_content").click(function () {
        $("#show_content").css("visibility","hidden");
    });

    var url = document.URL;
    var match = url.match(/page=([0-9]+)/);
    var page = 1;
    if(match != null){page = match[1]}
    $("#p_"+page).addClass("active");

    var type = url.match(/search-type=([0-9]+)/);
    var t = "";
    var field = url.match(/search-field=([0-9]+)/);
    var f = "";
    if(type != null){t = type[1]}
    if(t==="1"){
        $("#normal").removeAttr("checked");
        $("#pattern").attr({"checked": "checked"});
        $("#pattern-button").addClass("active");
        $("#normal-button").removeClass("active");
    }
    else{
        $("#pattern").removeAttr("checked");
        $("#normal").attr({"checked": "checked"});
        $("#normal-button").addClass("active");
        $("#pattern-button").removeClass("active");
    }
    if(field != null){f = field[1]}
    if(f==="0"){
        $("#ancient").removeAttr("checked");
        $("#modern").attr({"checked": "checked"});
        $("#modern-button").addClass("active");
        $("#ancient-button").removeClass("active");
    }
    else {
        $("#modern").removeAttr("checked");
        $("#ancient").attr({"checked": "checked"});
        $("#ancient-button").addClass("active");
        $("#modern-button").removeClass("active");
    }


    $("#normal-button").click(function () {
        $("#pattern").removeAttr("checked");
        $("#normal").attr({"checked": "checked"});
        $("#normal-button").addClass("active");
        $("#pattern-button").removeClass("active");
    });
    $("#pattern-button").click(function () {
        $("#normal").removeAttr("checked");
        $("#pattern").attr({"checked": "checked"});
        $("#pattern-button").addClass("active");
        $("#normal-button").removeClass("active");
    });

    $("#modern-button").click(function () {
        $("#ancient").removeAttr("checked");
        $("#modern").attr({"checked": "checked"});
        $("#modern-button").addClass("active");
        $("#ancient-button").removeClass("active");
    });
    $("#ancient-button").click(function () {
        $("#modern").removeAttr("checked");
        $("#ancient").attr({"checked": "checked"});
        $("#ancient-button").addClass("active");
        $("#modern-button").removeClass("active");
    });
}
</script>
{% endblock %}
